# Image convolution

CLI-приложение для свёртки изображений с различными ядрами свёртки,
а также сравнения различных параллельных реализаций свёртки и пайплайнов для свёртки массива изображений.

Приложение поддерживает 8битные изображения с одним или тремя каналами (RGB).

## Quick start

Для работы приложения требуется JDK 21+.

Для запуска свёртки над одним изображением:

```bash
./gradlew run --args="path/to/image.png filterName"
```

Свёрнутое изображение сохранится как output_image.

Для запуска свёртки над всеми изображениями в директории:

```bash
./gradlew run --args="path/to/folder filterName"
```

Свёрнутые изображения сохранятся в директорию output_images.

Доступные фильтры:

- id
- boxBlur
- motionBlur
- gaussianBlur3x3
- gaussianBlur5x5
- edges
- sharpen5
- sharpen8
- embos

## Реализация

В приложении есть различные реализации свёртки:

- полностью последовательная свёртка
- параллельное разделение по каналам изображения (для RGB)
- параллельное разделение по строкам изображения
- параллельное разделение по столбцам изображения
- параллельное разделение по пикселям изображения
- параллельное разделение по прямоугольникам изображения

Все параллельные реализации используют разделение по каналам изображения.

Также реализован асинхронный пайплайн для свёртки массива изображений,
который читает, сворачивает и записывает изображения.

## Эксперимент

Были произведены следующие эксперименты:

- сравнение различных реализаций свёртки на изображениях размером 1280x853 и 3000x2000 пикселей.
- сравнения последовательного и асинхронного пайплайна.

### Условия эксперимента

- процессор: Ryzen 7 5800H (8C/16T)
- оперативная память: 16 ГБ DDR4
- операционная система: Debian 12 (with Linux 6.12.22)

### Свёртка

Результаты сравнения различных реализаций свёртки представлены в таблице ниже.
В ней представлено среднее время свёртки и среднее отклонение для двух изображений.

| Размер изображения  | Полностью последовательная | Разделение каналов | По 1 столбцу | По 1 строке | По 5 столбцов | По 5 строк  | По 100 столбцов | По 100 строк | Прямоугольники 5×5 | Прямоугольники 50×50 | По элементам   |
|---------------------|----------------------------|--------------------|--------------|-------------|---------------|-------------|-----------------|--------------|--------------------|----------------------|----------------|
| 1280×853 (bird.png) | 1042 ± 11 ms               | 364 ± 2 ms         | 149 ± 6 ms   | 144 ± 9 ms  | 153 ± 6 ms    | 143 ± 4 ms  | 139 ± 5 ms      | 159 ± 5 ms   | 161 ± 10 ms        | 160 ± 13 ms          | 638 ± 23 ms    |
| 3000×2000 (kha.bmp) | 5682 ± 12 ms               | 1808 ± 76 ms       | 755 ± 7 ms   | 756 ± 3 ms  | 824 ± 7 ms    | 721 ± 11 ms | 750 ± 5 ms      | 731 ± 12 ms  | 932 ± 94 ms        | 840 ± 2 ms           | 4745 ± 1383 ms |

И на диаграмме:

![Сравнение реализаций свёртки](convolution.png)

Лучшее время работы получилось при разделении по строкам, столбцам и прямоугольникам.
Разница между разделением по строкам и столбцам оказалась невелика.

При разделении по прямоугольникам на больших изображениях оказалось лучше разделение
на более крупные прямоугольники 50×50 по сравнению с 5×5.

Разделение по каждому пикселю оказалось неэффективно.
Разделение только по каналам изображения также оказалось менее неэффективно.

### Пайплайны

Результаты сравнения асинхронного и последовательного пайплайна для обработки массива изображений
представлено в таблице ниже.
В ней представлено среднее время свёртки и среднее отклонение для массива изображений, состоящего из
7 изображений 1280×853 и 8 изображений 3000×2000, при различных реализациях свёртки.

| Пайплайн         | Полностью последовательная реализация | Разделение каналов | Разделение по пять столбцов | Разделение по 5 строк | Разделение по прямоугольникам 50×50 |
|------------------|---------------------------------------|--------------------|-----------------------------|-----------------------|-------------------------------------|
| Асинхронный      | 9.4 ± 0.1 с                           | 8.9 ± 0.2 с        | 7.9 ± 0.1 с                 | 7.4 ± 0.1 с           | 8.2 ± 0.1 с                         |
| Последовательный | 53.8 ± 0.1 с                          | 18.4 ± 0.1 с       | 9.3 ± 0.1 с                 | 8.8 ± 0.1 с           | 8.7 ± 0.1 с                         |

И на диаграмме:

![Сравнение пайплайнов](pipelines.png)

Асинхронный пайплайн оказался лучше при всех реализациях свёртки.

Лучшее время работы асинхронного пайплайна получилось при параллельной
свёртке изображения с разделением по 5 строк и по 5 столбцов.

## Тестирование

Тестирование производилось путём сравнивания реализации из
библиотеки [Boofcv](https://github.com/lessthanoptimal/BoofCV)
с допустимой погрешностью пикселей, равной единице.

Протестированы различные реализации свёртки (параллельные и последовательная) с различными фильтрами на
изображениях различных размеров.

Для запуска тестов:

```bash
./gradlew test  
```

## Структура репозитория

```text
.
├── app - модуль с CLI, последовательным и параллельным пайплайном и бенчмарками. 
├── buildSrc - общие зависимости и конфигурации модулей.
├── convolution - свёртка изображений и различные ядра свёртки.
├── images - изображения для тестов и бенчмарков.
├── plotting - python скрипты для построения графиков результатов бенчмарков.
```

## Использованные технологии

- [BoofCV](https://github.com/lessthanoptimal/BoofCV) - для загрузки, получения каналов изображения и записи.
  изображений.
- [jmh](https://github.com/openjdk/jmh) - для бенчмарков.